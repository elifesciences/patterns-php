elifeLibrary {
    def commit
    def branch
    stage 'Checkout and branch', {
        checkout scm
        commit = elifeGitRevision()
        branch = 'update_pattern_library_pull_request/' + params.pattern_library_branch
        sh "git checkout -b ${branch} && git reset --hard origin/master"
    }

    stage "Update", {
        sh "composer install"

        sh "bin/update origin/${params.pattern_library_branch}"
        sh "git add --all ."
    }

    def differences
    def shortDescription
    stage 'Commit', {
        differences = elifeGitDifferences()
        elifeOnlyIf differences, {
            def subrepositorySummary = elifeGitSubrepositorySummary 'pattern-library'
            shortDescription = "Updated pattern-library to ${subrepositorySummary}"
            elifeGitCommit shortDescription
        }
    }

    stage 'Push', {
        elifeOnlyIf differences, {
            sh "git push origin -f ${branch}"
        }
    }
}
